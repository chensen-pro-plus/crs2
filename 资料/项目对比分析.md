# Antigravity-Manager2 vs claude-relay-service2 对比分析

## 总体概述

| 维度 | Antigravity-Manager2 | claude-relay-service2 |
|-----|---------------------|----------------------|
| **技术栈** | Rust + Tauri + React | Node.js + Express |
| **应用类型** | 桌面应用（本地运行） | Web 服务（可 Docker 部署） |
| **代码规模** | ~50K 行 Rust 核心代码 | ~3K+ 行 JS 核心代码 |
| **目标用户** | 个人开发者 | 企业/团队 |

---

## 1. 技术架构差异

### Antigravity-Manager2 (Rust)
```
┌──────────────────────────────────────────────────────────────┐
│                     Tauri Desktop App                        │
├──────────────────────────────────────────────────────────────┤
│  Frontend (React + TypeScript)                               │
│  ├── 账号管理 UI                                              │
│  ├── API 反代配置                                             │
│  └── 监控面板                                                 │
├──────────────────────────────────────────────────────────────┤
│  Backend (Rust + Axum)                                       │
│  ├── handlers/       API 端点处理器                          │
│  ├── mappers/        协议转换器                               │
│  ├── upstream/       上游 HTTP 客户端                         │
│  ├── token_manager   账号令牌管理                             │
│  └── middleware/     认证/监控中间件                          │
└──────────────────────────────────────────────────────────────┘
```

### claude-relay-service2 (Node.js)
```
┌──────────────────────────────────────────────────────────────┐
│                   Express Web Server                          │
├──────────────────────────────────────────────────────────────┤
│  routes/                                                      │
│  ├── api.js                 主路由分流                        │
│  └── openaiGeminiRoutes.js  OpenAI→Gemini 路由               │
├──────────────────────────────────────────────────────────────┤
│  services/                                                    │
│  ├── antigravityClient.js          上游客户端                 │
│  ├── anthropicGeminiBridgeService.js 协议转换                │
│  ├── unifiedGeminiScheduler.js     统一调度器                 │
│  └── geminiAccountService.js       账号服务                   │
├──────────────────────────────────────────────────────────────┤
│  utils/                                                       │
│  ├── geminiSchemaCleaner.js        Schema 清洗               │
│  └── antigravityModel.js           模型映射                   │
├──────────────────────────────────────────────────────────────┤
│  web/ (管理后台)                                              │
│  └── React 管理界面                                           │
└──────────────────────────────────────────────────────────────┘
```

---

## 2. 支持的协议端点

| 协议 | Antigravity-Manager2 | claude-relay-service2 |
|-----|---------------------|----------------------|
| **OpenAI** | ✅ `/v1/chat/completions` | ✅ `/openai/v1/chat/completions` |
| **Anthropic** | ✅ `/v1/messages` | ✅ `/antigravity/api/v1/messages` |
| **Gemini** | ✅ `/v1beta/models` | ✅ `/gemini/api/` |
| **图像生成** | ✅ `/v1/images/generations` | ❌ 不支持 |
| **音频转录** | ✅ `/v1/audio/transcriptions` | ❌ 不支持 |
| **MCP 协议** | ✅ `/mcp/*` (z.ai MCP) | ❌ 不支持 |

---

## 3. 上游 API 端点

### 共同点
两者都使用 **Google Cloud Code v1internal API**：

| 端点 | URL |
|-----|-----|
| 生产环境 | `https://cloudcode-pa.googleapis.com` |
| 沙箱环境 | `https://daily-cloudcode-pa.sandbox.googleapis.com` |

### 差异点

| 特性 | Antigravity-Manager2 | claude-relay-service2 |
|-----|---------------------|----------------------|
| **Fallback 顺序** | prod → daily | daily → prod（Claude 模型优先 prod） |
| **额外端点** | EU 区域代理端点支持 | 仅标准端点 |
| **z.ai 支持** | ✅ 支持 z.ai Anthropic 直通 | ❌ 不支持 |

---

## 4. 账号调度机制

### Antigravity-Manager2

```rust
// token_manager.rs
pub struct TokenManager {
    tokens: DashMap<String, ProxyToken>,      // 并发安全的账号池
    current_index: AtomicUsize,               // 轮询索引
    rate_limiter: RateLimitTracker,           // 限流追踪
    sticky_config: StickySessionConfig,       // 粘性会话配置
}

// 调度策略
- 粘性会话：基于 SessionManager 生成的会话指纹维持账号绑定
- 分级路由：Ultra > Pro > Free 优先级排序
- 配额保护：低于阈值时自动禁用账号
- 智能预热：100% 配额时自动触发预热
```

### claude-relay-service2

```javascript
// unifiedGeminiScheduler.js
class UnifiedGeminiScheduler {
  SESSION_MAPPING_PREFIX = 'unified_gemini_session_mapping:'
  
  // 调度策略
  async selectAccountForApiKey(apiKeyData, sessionHash, requestedModel) {
    // 1. 检查粘性会话映射（Redis 缓存）
    // 2. 筛选可调度账户（oauthProvider = 'antigravity'）
    // 3. 按优先级和最后使用时间排序
    // 4. 检查账户可用性和限流状态
    // 5. 设置会话映射并返回
  }
}
```

### 关键差异

| 特性 | Antigravity-Manager2 | claude-relay-service2 |
|-----|---------------------|----------------------|
| **存储方式** | 本地内存 (DashMap) | Redis 缓存 |
| **会话粘性** | 时间窗口锁定（60s） | Redis TTL（默认 1 小时） |
| **账号类型区分** | tier (Ultra/Pro/Free) | oauthProvider (gemini-cli/antigravity) |
| **限流追踪** | 本地 RateLimitTracker | Redis 键值对 |
| **配额保护** | ✅ 自动禁用/恢复 | ❌ 无自动保护 |
| **智能预热** | ✅ 100% 配额触发 | ❌ 不支持 |

---

## 5. 协议转换实现

### Anthropic → Gemini 转换

| 转换项 | Antigravity-Manager2 | claude-relay-service2 |
|-------|---------------------|----------------------|
| **消息角色** | `assistant` → `model` | 同左 |
| **消息格式** | `messages[]` → `contents[]` | 同左 |
| **工具定义** | `tools[]` → `functionDeclarations[]` | 同左 |
| **工具调用** | `tool_use` → `functionCall` | 同左 |
| **工具结果** | `tool_result` → `functionResponse` | 同左 |

### 核心差异

#### Thinking 块处理

**Antigravity-Manager2 (Rust)**:
```rust
// handlers/claude.rs
fn filter_invalid_thinking_blocks(messages: &mut Vec<Message>) {
    // 1. 检查 signature 长度 >= 10
    // 2. 无效签名的 thinking 块转换为 text 块
    // 3. 保留空 thinking + 有效签名（尾部签名场景）
}
```

**claude-relay-service2 (JS)**:
```javascript
// anthropicGeminiBridgeService.js
function sanitizeThoughtSignatureForAntigravity(signature) {
  // 检查是否为 Base64-like token
  const base64Pattern = /^[A-Za-z0-9+/=_-]+$/
  if (!base64Pattern.test(signature)) {
    return ''  // 不合法则返回空串
  }
  return signature
}
```

#### 工具描述压缩

**claude-relay-service2** 有更激进的压缩策略：

```javascript
// 工具描述压缩到 400 字符
function compactToolDescriptionForAntigravity(description) {
  const lines = description.split('\n').slice(0, 6)  // 取前 6 行
  const merged = lines.join(' ')                      // 合并为单行
  return truncateInlineText(merged, 400)              // 截断到 400 字符
}

// Schema 描述压缩到 200 字符
function compactSchemaDescriptionForAntigravity(description) {
  const normalized = description.replace(/\s+/g, ' ').trim()
  return truncateInlineText(normalized, 200)
}
```

**Antigravity-Manager2** 没有类似的压缩策略，依赖 upstream 的 Schema 清洗。

---

## 6. 退避策略对比

### Antigravity-Manager2

```rust
enum RetryStrategy {
    NoRetry,
    FixedDelay(Duration),
    LinearBackoff { base_ms: u64 },
    ExponentialBackoff { base_ms, max_ms },
}

fn determine_retry_strategy(status_code: u16, error_text: &str) -> RetryStrategy {
    match status_code {
        400 => FixedDelay(200ms),           // Thinking 签名失败
        429 => LinearBackoff(1000ms),       // 限流
        503 | 529 => ExponentialBackoff(1s → 8s),  // 服务过载
        500 => LinearBackoff(500ms),        // 服务器错误
        401 | 403 => FixedDelay(100ms),     // 认证失败，轮换账号
        _ => NoRetry,
    }
}
```

### claude-relay-service2

```javascript
// antigravityClient.js
if (status === 429 && !retriedAfterDelay) {
  await sleep(2000)  // 固定等待 2 秒
  return await attemptRequest()
}
```

### 关键差异

| 特性 | Antigravity-Manager2 | claude-relay-service2 |
|-----|---------------------|----------------------|
| **策略类型** | 多种退避策略（固定/线性/指数） | 仅固定 2 秒延迟 |
| **最大重试** | 3 次（可配置） | 1 次 429 重试 |
| **服务过载处理** | 指数退避（1s→8s） | 端点 Fallback |
| **账号轮换** | 429/401/403/500 触发 | 无自动轮换 |

---

## 7. 特色功能对比

### Antigravity-Manager2 独有功能

| 功能 | 说明 |
|-----|------|
| **自动 Stream 转换** | 非流式请求自动转为流式以获得更宽松配额 |
| **Warmup 请求拦截** | 检测 Claude Code 心跳请求，返回模拟响应 |
| **后台任务智能降级** | 标题生成等任务降级到 Flash 模型 |
| **z.ai 多模式调度** | Off/Exclusive/Pooled/Fallback 四种模式 |
| **配额保护与恢复** | 低于阈值禁用，恢复后自动启用 |
| **智能预热** | 配额 100% 时自动触发账号预热 |
| **设备指纹绑定** | 账号与设备信息一对一绑定 |
| **Imagen 3 图像生成** | 支持多分辨率和比例 |
| **MCP 协议支持** | z.ai Web Search / Web Reader |

### claude-relay-service2 独有功能

| 功能 | 说明 |
|-----|------|
| **多账户类型支持** | claude-official / gemini-cli / antigravity / openai-responses |
| **Redis 会话管理** | 分布式会话粘性和限流追踪 |
| **API Key 权限系统** | 细粒度的服务访问控制 |
| **账户分组** | 支持按分组调度账户 |
| **工具描述压缩** | 激进的 prompt 体积优化 |
| **请求 Dump 调试** | 详细的上游请求/响应日志 |
| **Web 管理后台** | 基于浏览器的账号管理界面 |
| **Docker 部署** | 容器化一键部署 |

---

## 8. 请求包装格式

### Antigravity-Manager2 (Envelope 结构)

```rust
// 直接发送 Gemini 格式请求到 v1internal
{
  "contents": [...],
  "tools": [...],
  "generationConfig": {...},
  "thinkingConfig": {...}
}
```

### claude-relay-service2 (Envelope 结构)

```javascript
// 使用 project/requestId/model 包装
{
  "project": "ag-xxxxxxxxxxxxxxxx",
  "requestId": "req-uuid",
  "model": "claude-opus-4-5-20251101",
  "userAgent": "antigravity",
  "request": {
    "sessionId": "sess-uuid",
    "contents": [...],
    "tools": [...],
    "generationConfig": {...}
  }
}
```

### 关键差异

| 字段 | Antigravity-Manager2 | claude-relay-service2 |
|-----|---------------------|----------------------|
| **project** | 可选 | 必填 (自动生成) |
| **requestId** | 无 | 必填 (uuid) |
| **userAgent** | 无 | 固定 "antigravity" |
| **sessionId** | 使用 SessionManager | 嵌套在 request 中 |

---

## 9. 错误处理对比

### Antigravity-Manager2

```rust
// 统一的错误响应格式
{
  "type": "error",
  "error": {
    "type": "overloaded_error",
    "message": "No available accounts: ..."
  }
}

// 优雅降级
- Thinking 块无效签名 → 转换为 text 块
- 空响应流 → 自动重试
- 工具循环断裂 → 合成消息修复
```

### claude-relay-service2

```javascript
// 透传上游错误
throw error  // 直接抛出

// 前置校验
- Thinking signature → sanitize 或移除
- 工具 Schema → cleanJsonSchemaForGemini()
- tool_result → 截断到 20 万字符
```

---

## 10. 性能优化对比

| 优化项 | Antigravity-Manager2 | claude-relay-service2 |
|-------|---------------------|----------------------|
| **并发控制** | Rust 原生并发 (tokio) | Node.js 事件循环 |
| **连接复用** | HTTP/1.1 Keep-Alive | HTTP Agent Keep-Alive |
| **内存管理** | Rust 所有权系统 | Node.js GC |
| **流式处理** | 零拷贝字节流 | Buffer 转换 |
| **数据库** | SQLite (本地日志) | Redis (会话缓存) |

---

## 总结

| 维度 | 推荐选择 |
|-----|---------|
| **个人使用** | Antigravity-Manager2（桌面应用，零配置） |
| **团队部署** | claude-relay-service2（Web 服务，支持多用户） |
| **极致性能** | Antigravity-Manager2（Rust 原生性能） |
| **灵活扩展** | claude-relay-service2（Node.js 生态丰富） |
| **多协议支持** | Antigravity-Manager2（OpenAI/Claude/Gemini/MCP） |
| **分布式部署** | claude-relay-service2（Redis + Docker） |
| **图像/音频** | Antigravity-Manager2（Imagen 3 + Whisper） |
