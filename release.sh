#!/bin/bash
# Claude Relay Service ä¸€é”®å‘å¸ƒè„šæœ¬
# ç”¨æ³•: ./release.sh [--yes] [ç‰ˆæœ¬å·]
# ç¤ºä¾‹: ./release.sh 1.1.260
#       ./release.sh          # è‡ªåŠ¨é€’å¢ patch ç‰ˆæœ¬
#       ./release.sh --yes    # è·³è¿‡æ‰€æœ‰ç¡®è®¤

set -e

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Docker é•œåƒåç§°
DOCKER_IMAGE="weishaw/claude-relay-service"

# è§£æå‚æ•°
SKIP_CONFIRM=false
VERSION_ARG=""

for arg in "$@"; do
    case $arg in
        --yes|-y)
            SKIP_CONFIRM=true
            ;;
        *)
            VERSION_ARG="$arg"
            ;;
    esac
done

echo -e "${BLUE}ğŸš€ Claude Relay Service å‘å¸ƒè„šæœ¬${NC}"
echo ""

# æ£€æŸ¥æ˜¯å¦åœ¨é¡¹ç›®æ ¹ç›®å½•
if [ ! -f "VERSION" ] || [ ! -f "package.json" ]; then
    echo -e "${RED}âŒ è¯·åœ¨é¡¹ç›®æ ¹ç›®å½•è¿è¡Œæ­¤è„šæœ¬${NC}"
    exit 1
fi

# æ£€æŸ¥æ˜¯å¦æœ‰æœªæäº¤çš„æ›´æ”¹
if [ -n "$(git status --porcelain)" ]; then
    echo -e "${YELLOW}âš ï¸  æ£€æµ‹åˆ°æœªæäº¤çš„æ›´æ”¹ï¼š${NC}"
    git status --short
    echo ""
    if [ "$SKIP_CONFIRM" = false ]; then
        read -p "æ˜¯å¦ç»§ç»­å‘å¸ƒï¼Ÿ(y/N): " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            echo -e "${YELLOW}å·²å–æ¶ˆ${NC}"
            exit 0
        fi
    else
        echo -e "${YELLOW}è·³è¿‡ç¡®è®¤ (--yes)${NC}"
    fi
fi

# è·å–å½“å‰ç‰ˆæœ¬
CURRENT_VERSION=$(cat VERSION | tr -d '[:space:]')
echo -e "å½“å‰ç‰ˆæœ¬: ${BLUE}${CURRENT_VERSION}${NC}"

# è®¡ç®—æ–°ç‰ˆæœ¬
if [ -n "$VERSION_ARG" ]; then
    NEW_VERSION="$VERSION_ARG"
else
    # è‡ªåŠ¨é€’å¢ patch ç‰ˆæœ¬
    MAJOR=$(echo $CURRENT_VERSION | cut -d. -f1)
    MINOR=$(echo $CURRENT_VERSION | cut -d. -f2)
    PATCH=$(echo $CURRENT_VERSION | cut -d. -f3)
    NEW_PATCH=$((PATCH + 1))
    NEW_VERSION="${MAJOR}.${MINOR}.${NEW_PATCH}"
fi

NEW_TAG="v${NEW_VERSION}"
echo -e "æ–°ç‰ˆæœ¬:   ${GREEN}${NEW_VERSION}${NC}"
echo ""

if [ "$SKIP_CONFIRM" = false ]; then
    read -p "ç¡®è®¤å‘å¸ƒ ${NEW_VERSION}ï¼Ÿ(y/N): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo -e "${YELLOW}å·²å–æ¶ˆ${NC}"
        exit 0
    fi
fi

echo ""
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"

# Step 1: æ„å»ºå‰ç«¯
echo -e "${BLUE}[1/6] æ„å»ºå‰ç«¯...${NC}"
cd web/admin-spa
npm ci --silent
npm run build
cd ../..
echo -e "${GREEN}âœ… å‰ç«¯æ„å»ºå®Œæˆ${NC}"

# Step 2: æ›´æ–° VERSION æ–‡ä»¶
echo -e "${BLUE}[2/6] æ›´æ–°ç‰ˆæœ¬å·...${NC}"
echo "$NEW_VERSION" > VERSION
echo -e "${GREEN}âœ… VERSION å·²æ›´æ–°ä¸º ${NEW_VERSION}${NC}"

# Step 3: æ¨é€ web-dist åˆ†æ”¯
echo -e "${BLUE}[3/6] æ¨é€å‰ç«¯äº§ç‰©åˆ° web-dist åˆ†æ”¯...${NC}"

# ä¿å­˜å½“å‰åˆ†æ”¯
CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)

# åˆ›å»ºä¸´æ—¶ç›®å½•ä¿å­˜å‰ç«¯äº§ç‰©
TEMP_DIR=$(mktemp -d)
cp -r web/admin-spa/dist/* "$TEMP_DIR/"

# åˆ‡æ¢åˆ° web-dist åˆ†æ”¯
if git ls-remote --heads origin web-dist | grep -q web-dist; then
    git fetch origin web-dist:web-dist 2>/dev/null || true
    git checkout web-dist
else
    git checkout --orphan web-dist
fi

# æ¸…ç©ºå¹¶å¤åˆ¶æ–°æ–‡ä»¶
git rm -rf . 2>/dev/null || true
cp -r "$TEMP_DIR"/* .

# æ·»åŠ  README
cat > README.md << EOF
# Claude Relay Service - Web Frontend Build

This branch contains the pre-built frontend assets for Claude Relay Service.

**DO NOT EDIT FILES IN THIS BRANCH DIRECTLY**

These files are automatically generated by the release script.

Version: ${NEW_VERSION}
Build Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
EOF

# æäº¤å¹¶æ¨é€
git add --all
git commit -m "chore: update frontend build for ${NEW_TAG} [skip ci]" || echo "æ— å˜æ›´"
git push origin web-dist --force

# åˆ‡å›åŸåˆ†æ”¯
git checkout "$CURRENT_BRANCH"

# æ¸…ç†ä¸´æ—¶ç›®å½•
rm -rf "$TEMP_DIR"

echo -e "${GREEN}âœ… web-dist åˆ†æ”¯å·²æ›´æ–°${NC}"

# Step 4: æäº¤ä¸»åˆ†æ”¯
echo -e "${BLUE}[4/6] æäº¤ä¸»åˆ†æ”¯æ›´æ”¹...${NC}"
git add VERSION
git commit -m "chore: bump version to ${NEW_VERSION} [skip ci]" || echo "VERSION æ— å˜æ›´"
git push origin "$CURRENT_BRANCH"
echo -e "${GREEN}âœ… ä¸»åˆ†æ”¯å·²æ¨é€${NC}"

# Step 5: åˆ›å»ºå¹¶æ¨é€ Tag
echo -e "${BLUE}[5/6] åˆ›å»º Git Tag...${NC}"
git tag -a "${NEW_TAG}" -m "Release ${NEW_TAG}"
git push origin "${NEW_TAG}"
echo -e "${GREEN}âœ… Tag ${NEW_TAG} å·²åˆ›å»º${NC}"

# Step 6: æ„å»ºå¹¶æ¨é€ Docker é•œåƒ
echo -e "${BLUE}[6/6] æ„å»ºå¹¶æ¨é€ Docker é•œåƒ...${NC}"

# æ£€æŸ¥ Docker æ˜¯å¦ç™»å½•
if ! docker info 2>/dev/null | grep -q "Username"; then
    echo -e "${YELLOW}è¯·å…ˆç™»å½• Docker Hub:${NC}"
    docker login
fi

docker build -t ${DOCKER_IMAGE}:${NEW_TAG} .
docker tag ${DOCKER_IMAGE}:${NEW_TAG} ${DOCKER_IMAGE}:${NEW_VERSION}
docker tag ${DOCKER_IMAGE}:${NEW_TAG} ${DOCKER_IMAGE}:latest

docker push ${DOCKER_IMAGE}:${NEW_TAG}
docker push ${DOCKER_IMAGE}:${NEW_VERSION}
docker push ${DOCKER_IMAGE}:latest

echo -e "${GREEN}âœ… Docker é•œåƒå·²æ¨é€${NC}"

echo ""
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${GREEN}ğŸ‰ å‘å¸ƒå®Œæˆï¼${NC}"
echo ""
echo -e "ç‰ˆæœ¬:  ${GREEN}${NEW_VERSION}${NC}"
echo -e "Tag:   ${GREEN}${NEW_TAG}${NC}"
echo -e "é•œåƒ:  ${GREEN}${DOCKER_IMAGE}:${NEW_TAG}${NC}"
echo ""
echo -e "ç”¨æˆ·æ›´æ–°æ–¹å¼:"
echo -e "  è„šæœ¬éƒ¨ç½²: ${BLUE}crs update${NC}"
echo -e "  Docker:   ${BLUE}docker pull ${DOCKER_IMAGE}:latest${NC}"
